<div class="withdrawals-container">
  <div class="page-header">
    <button class="back-btn" (click)="goBack()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Volver
    </button>
    <h1>Retiro de mi dinero</h1>
    <p class="page-subtitle">Gestiona tus retiros y consulta tu historial de pagos</p>
  </div>

  <div class="stats-grid" *ngIf="!loading">
    <div class="stat-card balance-card">
      <div class="stat-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 6v6l4 2"></path>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">Saldo disponible</div>
        <div class="stat-value">{{ formatCurrency(availableBalance) }}</div>
        <div class="stat-info">Listo para retirar</div>
      </div>
    </div>

    <div class="stat-card" [class.limit-warning]="monthlyWithdrawals >= maxMonthlyWithdrawals">
      <div class="stat-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
          <line x1="1" y1="10" x2="23" y2="10"></line>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-label">Retiros este mes</div>
        <div class="stat-value">{{ monthlyWithdrawals }} / {{ maxMonthlyWithdrawals }}</div>
        <div class="stat-info">{{ withdrawalLimitMessage }}</div>
      </div>
    </div>
  </div>

  <div class="withdrawal-action" *ngIf="!loading">
    <button
      class="withdraw-btn-primary"
      (click)="requestWithdrawal()"
      [disabled]="!canWithdraw || isProcessingWithdrawal"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <polyline points="19 12 12 19 5 12"></polyline>
      </svg>
      <span *ngIf="!isProcessingWithdrawal">Retirar mi dinero</span>
      <span *ngIf="isProcessingWithdrawal">Procesando...</span>
    </button>
    <p class="withdraw-info-text">El dinero llegará a tu cuenta bancaria en 2-3 días hábiles</p>
  </div>

  <div class="history-section">
    <div class="section-header">
      <h2>Historial de pagos de suscriptores</h2>
      <p class="section-description">Últimos 10 pagos recibidos</p>
    </div>

    <div class="loading-state" *ngIf="loading">
      <div class="spinner"></div>
      <p>Cargando historial...</p>
    </div>

    <div class="empty-state" *ngIf="!loading && historicalPayments.length === 0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="12" y1="1" x2="12" y2="23"></line>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
      </svg>
      <h3>No hay pagos registrados</h3>
      <p>Cuando tus suscriptores realicen pagos, aparecerán aquí</p>
    </div>

    <div class="payments-list" *ngIf="!loading && historicalPayments.length > 0">
      <div class="payment-card" *ngFor="let payment of historicalPayments">
        <div class="payment-main">
          <div class="payment-info">
            <div class="payment-subscriber">{{ payment.customer?.firstName! || 'Suscriptor' }}</div>
            <div class="payment-date">{{ formatDate(payment.transactionDate!) }}</div>
          </div>
          <div class="payment-amount">{{ formatCurrency(payment.amount!) }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="history-section">
    <div class="section-header">
      <h2>Historial de retiros</h2>
      <p class="section-description">Últimos 10 retiros realizados</p>
    </div>

    <div class="empty-state" *ngIf="!loading && historicalWithdrawals.length === 0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <rect x="3" y="8" width="18" height="4" rx="1"></rect>
        <path d="M12 8V5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3"></path>
        <path d="M3 12v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
      </svg>
      <h3>No hay retiros registrados</h3>
      <p>Cuando realices tu primer retiro, aparecerá aquí</p>
    </div>

    <div class="withdrawals-list" *ngIf="!loading && historicalWithdrawals.length > 0">
      <div class="withdrawal-card" *ngFor="let withdrawal of historicalWithdrawals">
        <div class="withdrawal-main">
          <div class="withdrawal-info">
            <div class="withdrawal-amount">{{ formatCurrency(withdrawal.amount!) }}</div>
            <div class="withdrawal-date">{{ formatDate(withdrawal.transactionDate!) }}</div>
          </div>
          <div class="withdrawal-status">
            <span class="status-badge" [ngClass]="getStatusClass(withdrawal.status!)">
              {{ getStatusLabel(withdrawal.status!) }}
            </span>
          </div>
        </div>
        <div class="withdrawal-footer" *ngIf="withdrawal.transactionDate">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span>Completado el {{ formatDate(withdrawal.transactionDate) }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación -->
<div class="modal-overlay" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-icon-wrapper warning">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 8v4"></path>
          <circle cx="12" cy="16" r="0.5" fill="currentColor"></circle>
        </svg>
      </div>
      <h3 class="modal-title">Confirmar retiro</h3>
      <p class="modal-description">
        ¿Estás seguro de que deseas retirar <strong>{{ formatCurrency(withdrawalAmountToConfirm) }}</strong>?
      </p>
      <p class="modal-info-small">
        El dinero llegará a tu cuenta bancaria en 2-3 días hábiles.
      </p>
    </div>
    <div class="modal-actions">
      <button class="modal-btn cancel" (click)="closeConfirmModal()">
        Cancelar
      </button>
      <button class="modal-btn confirm" (click)="confirmWithdrawal()" [disabled]="isProcessingWithdrawal">
        <span *ngIf="!isProcessingWithdrawal">Confirmar retiro</span>
        <span *ngIf="isProcessingWithdrawal">Procesando...</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal de éxito -->
<div class="modal-overlay" *ngIf="showSuccessModal" (click)="closeSuccessModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-icon-wrapper success">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="16 8 10 14 8 12"></polyline>
        </svg>
      </div>
      <h3 class="modal-title">¡Retiro exitoso!</h3>
      <p class="modal-description">Tu solicitud de retiro ha sido procesada correctamente.</p>
      <p class="modal-info">Recibirás <strong>{{ formatCurrency(withdrawalAmountToConfirm) }}</strong> en tu cuenta bancaria en 2-3 días hábiles.</p>
    </div>
    <div class="modal-actions">
      <button class="modal-btn primary" (click)="closeSuccessModal()">Entendido</button>
    </div>
  </div>
</div>
