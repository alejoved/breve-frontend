<div class="plans-container" *ngIf="!loading && !showCreateView">
  <div class="header-section">
    <h2 class="page-title">Planes</h2>
    <button class="create-btn" (click)="openCreateView()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Crear Plan
    </button>
  </div>

  <div class="plans-grid">
    <div class="plan-card" *ngFor="let plan of plans">
      <div class="plan-header">
        <div class="plan-title-section">
          <h3 class="plan-name">{{ plan.name }}</h3>
          <span class="plan-status" [class.active]="plan.is_active" [class.inactive]="!plan.is_active">
            {{ plan.is_active ? 'Activo' : 'Inactivo' }}
          </span>
        </div>
        <div class="plan-actions">
          <button class="action-icon-btn" (click)="openEditView(plan)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
          <button class="action-icon-btn" (click)="openDeleteConfirm(plan)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="plan-price">
        <span class="price-amount">{{ formatCurrency(plan.price) }}</span>
        <span class="price-period">/{{ plan.period === 'monthly' ? 'mes' : 'año' }}</span>
      </div>

      <p class="plan-description">{{ plan.description || 'Sin descripción' }}</p>

      <div class="plan-features" *ngIf="plan.features && plan.features.length > 0">
        <div class="feature-badge" *ngFor="let feature of plan.features">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          {{ feature }}
        </div>
      </div>

      <div class="plan-footer">
        <button
          class="toggle-btn"
          [class.active]="plan.is_active"
          (click)="togglePlanStatus(plan)"
        >
          {{ plan.is_active ? 'Desactivar' : 'Activar' }}
        </button>
      </div>
    </div>

    <div class="empty-state" *ngIf="plans.length === 0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M20 7h-9"></path>
        <path d="M14 17H5"></path>
        <circle cx="17" cy="17" r="3"></circle>
        <circle cx="7" cy="7" r="3"></circle>
      </svg>
      <h3>No hay planes creados</h3>
      <p>Crea tu primer plan usando el botón "Crear Plan" en la parte superior.</p>
    </div>
  </div>
</div>

<div class="loading-state" *ngIf="loading">
  <div class="spinner"></div>
  <p>Cargando planes...</p>
</div>

<div class="create-plan-view" *ngIf="showCreateView">
  <div class="create-plan-header">
    <button class="back-btn" (click)="closeCreateView()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <h1 class="create-plan-title">{{ editingPlan ? 'Editar Plan' : 'Crear Nuevo Plan' }}</h1>
  </div>

  <div class="create-plan-content">
    <form class="create-plan-form" (ngSubmit)="savePlan()">
      <div class="form-section">
        <h3 class="section-title">Información Básica</h3>

        <div class="form-group">
          <label class="form-label">Nombre del Plan <span class="required">*</span></label>
          <input
            type="text"
            class="form-input"
            [class.error]="errors.name && touched.name"
            placeholder="Ej: Plan Premium"
            [(ngModel)]="formData.name"
            (ngModelChange)="validateName()"
            (blur)="onFieldBlur('name')"
            name="name"
            required
          />
          <div *ngIf="errors.name && touched.name" class="field-error">
            {{ errors.name }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Descripción <span class="required">*</span></label>
          <textarea
            class="form-input"
            [class.error]="errors.description && touched.description"
            placeholder="Describe brevemente tu plan de suscripción"
            [(ngModel)]="formData.description"
            (ngModelChange)="validateDescription()"
            (blur)="onFieldBlur('description')"
            name="description"
            rows="3"
          ></textarea>
          <div *ngIf="errors.description && touched.description" class="field-error">
            {{ errors.description }}
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">Precio y Facturación</h3>

        <div class="price-period-grid">
          <div class="form-group">
            <label class="form-label">Precio <span class="required">*</span></label>
            <div class="price-input-wrapper">
              <span class="price-currency">$</span>
              <input
                type="number"
                class="form-input price-input"
                [class.error]="errors.price && touched.price"
                placeholder="199"
                [(ngModel)]="formData.price"
                (ngModelChange)="validatePrice()"
                (blur)="onFieldBlur('price')"
                name="price"
                required
                min="0"
              />
            </div>
            <div *ngIf="errors.price && touched.price" class="field-error">
              {{ errors.price }}
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Período</label>
            <div class="period-buttons">
              <button
                type="button"
                class="period-btn"
                [class.active]="formData.period === 'monthly'"
                (click)="setPeriod('monthly')"
              >
                Mensual
              </button>
              <button
                type="button"
                class="period-btn"
                [class.active]="formData.period === 'yearly'"
                (click)="setPeriod('yearly')"
              >
                Anual
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">Características del Plan</h3>
          <button type="button" class="add-feature-btn" (click)="addFeature()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Agregar
          </button>
        </div>

        <div class="form-group">
          <input
            type="text"
            class="form-input"
            placeholder="Característica 1"
            [(ngModel)]="newFeature"
            name="newFeature"
            (keyup.enter)="addFeature()"
          />
        </div>

        <div class="features-list" *ngIf="formData.features.length > 0">
          <div class="feature-item" *ngFor="let feature of formData.features; let i = index">
            <span>{{ feature }}</span>
            <button type="button" class="remove-feature-btn" (click)="removeFeature(i)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">Contrato del Plan</h3>
        <p class="section-description">Este contrato se mostrará a los usuarios durante el proceso de suscripción (opcional)</p>

        <div class="form-group">
          <label class="form-label">Términos y Condiciones</label>
          <textarea
            class="form-input contract-textarea"
            [class.error]="errors.contract && touched.contract"
            placeholder="Escribe los términos y condiciones del plan. Por ejemplo: 'Al suscribirte aceptas los siguientes términos...'"
            [(ngModel)]="formData.contract"
            (ngModelChange)="validateContract()"
            (blur)="onFieldBlur('contract')"
            name="contract"
            rows="8"
          ></textarea>
          <div *ngIf="errors.contract && touched.contract" class="field-error">
            {{ errors.contract }}
          </div>
          <p class="field-hint">Puedes incluir políticas de cancelación, renovación automática, métodos de pago, etc.</p>
        </div>
      </div>

      <div class="form-section">
        <h3 class="section-title">Estado del Plan</h3>

        <div class="status-toggle">
          <div class="status-info">
            <h4 class="status-title">Plan Activo</h4>
            <p class="status-description">Los usuarios podrán suscribirse inmediatamente</p>
          </div>
          <label class="toggle-switch">
            <input
              type="checkbox"
              [(ngModel)]="formData.is_active"
              name="is_active"
            />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="submit-btn">
          {{ editingPlan ? 'Guardar Cambios' : 'Crear Plan' }}
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="closeDeleteConfirm()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-icon-wrapper danger">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <h3 class="modal-title">Eliminar Plan</h3>
      <p class="modal-description">
        ¿Estás seguro de que deseas eliminar el plan <strong>"{{ planToDelete?.name }}"</strong>?
        Esta acción no se puede deshacer.
      </p>
    </div>
    <div class="modal-actions">
      <button class="modal-btn cancel" (click)="closeDeleteConfirm()">
        Cancelar
      </button>
      <button class="modal-btn danger" (click)="confirmDelete()">
        Eliminar Plan
      </button>
    </div>
  </div>
</div>
